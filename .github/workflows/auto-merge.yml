name: auto-merge

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    name: enable-auto-merge
    if: >
      github.event.pull_request.draft == false &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Enable PR auto-merge (squash)
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -u
          set -o pipefail

          PR_ID="$(gh pr view "${PR_NUMBER}" --repo "${GH_REPO}" --json id -q '.id')"
          if [ -z "${PR_ID}" ]; then
            echo "::warning::PR node id 조회 실패로 auto-merge 설정을 건너뜁니다."
            exit 0
          fi

          set +e
          OUTPUT="$(gh api graphql \
            -f query='mutation($pullRequestId: ID!) { enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }) { clientMutationId } }' \
            -f pullRequestId="${PR_ID}" 2>&1)"
          STATUS=$?
          set -e

          echo "${OUTPUT}"
          if [ "${STATUS}" -eq 0 ]; then
            exit 0
          fi

          if echo "${OUTPUT}" | grep -Eqi "AUTO_MERGE_ENABLED|Pull request is already merged|Pull request is closed|already enabled|Auto merge is not enabled for this repository"; then
            exit 0
          fi

          exit "${STATUS}"
